### 你为什么做这个框架，什么场景使用这个框架

我们实验室是做深度学习的, 在训练神经网络的时候一系列的异步流程, 比如网络训练, 验证, 图片生成等, 平时同门都是自己手动开启任务, 而且由于是多人竞争使用服务器, 就需要一个框架来任务调度,任务重试, 任务管理, 所以就做了这个异步任务管理框架

### asyncflow和消息队列有什么区别

 有考虑过消息队列实现, 但是因为消息队列主要用于消息流转, 而我们的框架可以处理分阶段任务, 而且我们的框架要用于任务管理, 比如创建,查询, 删除等, 这些用消息队列来实现相对麻烦一些

### 为什么不用业界已有的异步任务框架

 调研的时候我找到业界比较成熟的两个异步任务框架, 一个是python编写的celery, 一个是用go模仿celery的machinery, 发现他们都更倾向于消息流转, 而不是任务管理, 我们需要的是一个能快速实现异步任务的轻量级框架, 而且在多阶段任务中, 还需要更改上下文, 这里和celery和machinery的定位不一样, 同时machinery支持延迟任务机制 任务流模式等一系列机制, 这些是我们用不到的, 我们想实现的是一个支持任务管理,调度的轻量级框架

### 你的框架怎么接入呢

首先需要用户部署框架依赖的中间件MySQL和redis, 同时需要在MySQL中创建好位置信息表和任务配置表, 每一类的任务也需要一张任务信息表

接着就可以部署Brokersvr, 使用Brokersvr对应的创建任务的接口,  Broker会和部署的MySQL交互, 将任务存储到对应类型的任务信息表

然后就是消费任务

先把任务的具体逻辑写到worker里, 拉取到对应类型的任务之后就可以执行了, 具体点就是任务需要实现worker提供的三个接口方法, 才能将这类人物注册到框架

> 1. ContextLoad: 用户定义如何解析上下文
> 2. HandleProcess: 用户定义该任务类型真正的处理逻辑
> 3. HandleFinish: 用于处理任务完成后的逻辑, 比如发送任务完成的通知, 记录日志等

然后部署worker, 就可以消费任务了

### 你的框架怎么部署呢

业务方可以根据业务需求部署, 比如我们实验室是部署在2台16c32g4GPU服务器, 一台16c32g单卡的试验机, 在每台都部署了一个Broker, 由于Broker是提供web服务, 所以做了负载均衡, 每台机器四个worker

### 为什么存储用MySQL不用Redis？

首先是Redis的安全性还是不如MySQL, 还有我们的场景是任务管理, 会有很多关系型查询, 比如根据状态来拉取一批任务来执行, 或者查询某个用户待执行的任务, 而Redis并不支持关系型查询

### 上下文怎么存储的，存不下怎么办？

我们使用一个字段context来存储上下文, 最大8192字节, 日常任务中这些是够用的, 如果遇到存不下的情况, 亦可以用URL传递. 后续的完善上也可以使用MongoDB来做存储引擎, 这时上下文过大就可以看作是文档了.

### **讲讲任务创建的流程** 

首先通过http请求调用, 到达Broker之后, 会通过路由找到对应的执行函数, 解析参数并检查是否合法, 接着就可以执行创建任务, 先查询endpos获取需要插入的表号, 然后将数据插入数据库, 最后回包给调用方

### 任务拉取按什么顺序

worker会先通过http发起占据任务的请求, broker接收到之后根据路由找到占据任务函数, 检查参数合法之后从数据库拉取一批任务, 将这批任务设置为执行中, 填充返回包并回包给worker

### Worker怎么竞争任务

这里使用了分布式锁, worker拉取任务前会先竞争一个分布式锁, 拿到锁才能占据任务, broker收到占据请求后会先将这批任务设置为执行中, 再填充返回包给worker, worker 占据任务成功之后就会释放锁

### 任务如果执行中如果worker挂掉怎么办

挂掉的话任务会保持执行中的状态, 所以再框架中提供最大执行时间的配置, 超过执行时间就会由任务治理重置任务状态, 由于更新了上下文, 下次重做会从最新的阶段开始, 上下文更新之前的任务就不会再重复做了

### 分表为什么自己写 ，为什么不用组件 ？

分表组件比如MyCat是通过将业务字段 hash之后存到不同的分片里, 而我们的场景中只是用来记录任务, 对于执行完的数据, 过段时间就可以删除掉了, 所以更适合滚动分表一点, 分表之后任务消费和创建等主要操作都发生在热表上, 如果有通过任务id查询任务信息这种比较低频的操作, 也可以通过生成id的后缀去对应的表去查, 不管冷热

### 推荐分表的阈值是多少？为什么这么推荐？

我设置的是500w, 这个数值是根据阿里巴巴推荐设置的, 首先是需要把B+树层高维持在三层, 也就是大概2000w的量级, 但是由于很多时候查询并不全是走索引场景, 比如数量统计, 这类请求在500W左右就已经有压力了, 同时500W对于常见的任务生产消费来说是够用的, 所以选择了500W

### 你这个框架的性能怎么样

我们测试了主要的接口, 包括创建任务 查询任务 占据任务等, 创建任务一开始是300qps, 优化之后达到2000qps



### 为什么存储用MySQL不用MongoDB

MySQL和MongoDB都很适合, 我们的存储是封装过的, 后续我们也准备把MongoDB接入作为底层存储之一, 现在使用MySQL是因为对MySQL比较熟悉, 而且也完全能够满足业务需求. 因为大多数场景中任务上下文都是简洁的, 比如音视频上传等



